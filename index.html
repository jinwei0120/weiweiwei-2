<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±½è»Šæ•…éšœå•é¡Œå°å¹«æ‰‹</title>
    <style>
        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-section {
            margin: 20px 0;
            text-align: center;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .status {
            margin-top: 10px;
            font-size: 1em;
            color: #888;
            text-align: center;
        }
        .sensor-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-top: 20px;
        }
        .sensor-box {
            background: #eaf3fa;
            border-radius: 8px;
            padding: 18px 24px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(44,62,80,0.07);
        }
        .sensor-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        .sensor-value {
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 8px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— æ±½è»Šæ•…éšœå•é¡Œå°å¹«æ‰‹</h1>
        <div class="input-section">
            <button onclick="startRecognition()">ğŸ¤ æŒ‰ä¸‹é–‹å§‹èªéŸ³æè¿°æ•…éšœ</button>
            <div id="voiceText" style="margin-top:15px;color:#888;"></div>
        </div>
        <div class="input-section">
            <button onclick="connectArduinoWS()" id="connectArduinoBtn">ğŸ”Œ é€£æ¥ UNO å–å¾—æ„Ÿæ¸¬æ•¸æ“š</button>
            <div id="connectionStatus" class="status">æœªé€£ç·š</div>
        </div>
        <div class="sensor-container">
            <div class="sensor-box">
                <div class="sensor-title">ğŸŒ¡ï¸ æ°´æº«</div>
                <div id="sensor-water" class="sensor-value">--</div>
            </div>
            <div class="sensor-box">
                <div class="sensor-title">ğŸŒ¡ï¸ æ²¹æº«</div>
                <div id="sensor-oiltemp" class="sensor-value">--</div>
            </div>
            <div class="sensor-box">
                <div class="sensor-title">ğŸ›¢ï¸ æ©Ÿæ²¹å£“åŠ›</div>
                <div id="sensor-oilpress" class="sensor-value">--</div>
            </div>
            <div class="sensor-box">
                <div class="sensor-title">ğŸ”‹ é›»å£“</div>
                <div id="sensor-voltage" class="sensor-value">--</div>
            </div>
            <div class="sensor-box">
                <div class="sensor-title">ğŸ› è¼ªèƒå£“åŠ›</div>
                <div id="sensor-tire" class="sensor-value">--</div>
            </div>
            <div class="sensor-box">
                <div class="sensor-title">â›½ æ²¹è€—</div>
                <div id="sensor-fuel" class="sensor-value">--</div>
            </div>
        </div>
        <div id="aiResponse" style="margin-top: 20px; text-align: center;"></div>
    </div>

    <script>
        async function startRecognition() {
            const voiceText = document.getElementById('voiceText');
            voiceText.textContent = "æ­£åœ¨è†è½ï¼Œè«‹é–‹å§‹æè¿°æ‚¨çš„æ±½è»Šæ•…éšœå•é¡Œ...";

            try {
                // éŒ„éŸ³åŠŸèƒ½éœ€è‡ªè¡Œå¯¦ä½œï¼Œé€™è£¡å‡è¨­æœ‰ recordAudio()
                const audioBlob = await recordAudio();
                const base64Audio = await blobToBase64(audioBlob);

                const response = await fetch('https://speech.googleapis.com/v1/speech:recognize?key=AIzaSyB2i0nrRxRqKALXrxvPigNSSSaLHPxXLt8', {
                    method: 'POST',
                    body: JSON.stringify({
                        config: {
                            encoding: 'LINEAR16',
                            sampleRateHertz: 16000,
                            languageCode: 'zh-TW'
                        },
                        audio: {
                            content: base64Audio
                        }
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                let transcript = '';
                if (result.results && result.results[0] && result.results[0].alternatives[0]) {
                    transcript = result.results[0].alternatives[0].transcript;
                } else {
                    transcript = 'ç„¡æ³•è¾¨è­˜èªéŸ³å…§å®¹ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
                }
                voiceText.textContent = `æ‚¨èªªï¼šã€Œ${transcript}ã€`;
            } catch (error) {
                console.error("èªéŸ³è¾¨è­˜éŒ¯èª¤:", error);
                voiceText.textContent = "èªéŸ³è¾¨è­˜ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
            }
        }

        // éŒ„éŸ³åŠŸèƒ½ï¼ˆéœ€è‡ªè¡Œå¯¦ä½œï¼Œé€™è£¡åƒ…ç‚ºä½”ä½ï¼‰
        async function recordAudio() {
            // è«‹ç”¨ Web Audio API æˆ– MediaRecorder API å¯¦ä½œéŒ„éŸ³
            alert("è«‹è‡ªè¡Œå¯¦ä½œéŒ„éŸ³åŠŸèƒ½ï¼Œé€™è£¡åƒ…ç‚ºä½”ä½ã€‚");
            return new Blob();
        }

        // Blob è½‰ Base64
        async function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // è™•ç†æ±½è»Šæ•…éšœå•é¡Œçš„å‡½æ•¸
        function handleCarProblem(transcript) {
            const responseDiv = document.getElementById('aiResponse');
            let response;

            

            // æ ¹æ“šèªéŸ³è¼¸å…¥åŒ¹é…æ•…éšœè¨ºæ–·
            const matchedFault = faultDiagnosis.find(fault =>
                fault.keywords.some(keyword => transcript.includes(keyword))
            );

            if (matchedFault) {
                response = `
<b>æ•…éšœè¨ºæ–·ï¼š</b> ${matchedFault.keywords.join(', ')}<br>
<b>è¨ºæ–·å»ºè­°ï¼š</b> ${matchedFault.advice}<br>
<b>ä¼°åƒ¹ç¯„åœï¼š</b> ${matchedFault.cost}`;
            } else {
                response = `
æ„Ÿè¬æ‚¨çš„æè¿°ï¼<br>
<b>å»ºè­°æ‚¨ï¼š</b>
<ol>
<li>è©³ç´°è¨˜éŒ„æ•…éšœç¾è±¡ï¼ˆè²éŸ³ã€æ°£å‘³ã€ç‡ˆè™Ÿã€ç™¼ç”Ÿæ™‚æ©Ÿï¼‰ã€‚</li>
<li>è‹¥ç„¡æ³•è‡ªè¡Œæ’é™¤ï¼Œè«‹å°‹æ±‚å°ˆæ¥­æŠ€å¸«å”åŠ©ã€‚</li>
<li>å®šæœŸä¿é¤Šå¯é é˜²å¤šæ•¸å•é¡Œã€‚</li>
</ol>`;
            }

            responseDiv.innerHTML = `<div class="ai-message">${response}</div>`;
        }

        // é€£æ¥ UNO ä¸¦é¡¯ç¤ºæ„Ÿæ¸¬æ•¸æ“š
        function connectArduinoWS() {
            const connectionStatus = document.getElementById('connectionStatus');
            connectionStatus.textContent = "é€£ç·šä¸­...";

            // å‡è¨­ UNO WebSocket ä¼ºæœå™¨åœ¨ ws://localhost:8080
            let ws = new WebSocket('ws://localhost:8080');

            ws.onopen = function() {
                connectionStatus.textContent = "å·²é€£ç·š";
                console.log("WebSocket å·²é€£ç·š");
            };

            ws.onerror = function() {
                connectionStatus.textContent = "é€£ç·šéŒ¯èª¤";
                console.log("WebSocket é€£ç·šéŒ¯èª¤");
            };

            ws.onclose = function() {
                connectionStatus.textContent = "æœªé€£ç·š";
                console.log("WebSocket å·²é—œé–‰");
            };

            ws.onmessage = function(event) {
                // å‡è¨­æ”¶åˆ°çš„è³‡æ–™æ ¼å¼ç‚ºï¼š
                // { water: 90, oiltemp: 85, oilpress: 2.5, voltage: 13.8, tire: 32, fuel: 12.5 }
                try {
                    const data = JSON.parse(event.data);
                    if (typeof data.water !== "undefined") document.getElementById('sensor-water').textContent = data.water + " Â°C";
                    if (typeof data.oiltemp !== "undefined") document.getElementById('sensor-oiltemp').textContent = data.oiltemp + " Â°C";
                    if (typeof data.oilpress !== "undefined") document.getElementById('sensor-oilpress').textContent = data.oilpress + " bar";
                    if (typeof data.voltage !== "undefined") document.getElementById('sensor-voltage').textContent = data.voltage + " V";
                    if (typeof data.tire !== "undefined") document.getElementById('sensor-tire').textContent = data.tire + " psi";
                    if (typeof data.fuel !== "undefined") document.getElementById('sensor-fuel').textContent = data.fuel + " km/L";
                } catch (e) {
                    console.log("è³‡æ–™è§£æéŒ¯èª¤", e);
                }
            };
        }
    </script>
</body>
</html>
``` 